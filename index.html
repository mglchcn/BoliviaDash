<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Macroeconómico Bolivia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        /* Animación de carga */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loader">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin fa-3x text-blue-500 mb-4"></i>
            <p>Conectando con los datos...</p>
        </div>
    </div>

    <nav class="bg-slate-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold"><i class="fas fa-chart-line mr-2"></i>Macro Bolivia Dashboard</h1>
            <span class="text-sm text-gray-400" id="last-update">Cargando...</span>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-5 card border-l-4 border-blue-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-sm font-bold uppercase">Crecimiento PIB</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="kpi-pib">--</h2>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i class="fas fa-globe-americas fa-lg"></i></div>
                </div>
                <p class="text-sm text-green-500 mt-2 font-semibold"><i class="fas fa-arrow-up"></i> <span id="kpi-pib-var">--</span> vs año anterior</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 card border-l-4 border-orange-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-sm font-bold uppercase">Inflación Acum.</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="kpi-inflacion">--</h2>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full text-orange-600"><i class="fas fa-percentage fa-lg"></i></div>
                </div>
                <p class="text-sm text-gray-500 mt-2">IPC General</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 card border-l-4 border-emerald-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-sm font-bold uppercase">RIN (Millones $us)</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="kpi-rin">--</h2>
                    </div>
                    <div class="bg-emerald-100 p-3 rounded-full text-emerald-600"><i class="fas fa-coins fa-lg"></i></div>
                </div>
                 <p class="text-sm text-gray-500 mt-2 font-semibold">Reservas Netas</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 card border-l-4 border-purple-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-sm font-bold uppercase">Desempleo Urbano</p>
                        <h2 class="text-3xl font-bold text-gray-800" id="kpi-desempleo">--</h2>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full text-purple-600"><i class="fas fa-users fa-lg"></i></div>
                </div>
                <p class="text-sm text-gray-500 mt-2">Tasa trimestral</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Evolución del Crecimiento del PIB (%)</h3>
                <canvas id="chartPibLine"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Balanza Comercial (Export vs Import)</h3>
                <canvas id="chartBalanza"></canvas>
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-4">Semáforo de Riesgo Macroeconómico</h3>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="p-4 border rounded-lg">
                    <h4 class="font-bold text-gray-600 mb-2">Déficit Fiscal</h4>
                    <div id="semaforo-deficit-bg" class="w-16 h-16 mx-auto rounded-full bg-gray-200 flex items-center justify-center mb-2">
                        <i id="semaforo-deficit-icon" class="fas fa-minus text-white text-2xl"></i>
                    </div>
                    <p class="text-xl font-bold" id="val-deficit">--</p>
                    <p class="text-xs text-gray-400">Meta: < -3%</p>
                </div>
                <div class="p-4 border rounded-lg">
                    <h4 class="font-bold text-gray-600 mb-2">Deuda Externa / PIB</h4>
                    <div id="semaforo-deuda-bg" class="w-16 h-16 mx-auto rounded-full bg-gray-200 flex items-center justify-center mb-2">
                        <i id="semaforo-deuda-icon" class="fas fa-minus text-white text-2xl"></i>
                    </div>
                    <p class="text-xl font-bold" id="val-deuda">--</p>
                    <p class="text-xs text-gray-400">Umbral Riesgo: > 30%</p>
                </div>
                <div class="p-4 border rounded-lg">
                    <h4 class="font-bold text-gray-600 mb-2">Brecha Cambiaria</h4>
                    <div id="semaforo-cambio-bg" class="w-16 h-16 mx-auto rounded-full bg-gray-200 flex items-center justify-center mb-2">
                        <i id="semaforo-cambio-icon" class="fas fa-minus text-white text-2xl"></i>
                    </div>
                    <p class="text-xl font-bold" id="val-cambio">--</p>
                    <p class="text-xs text-gray-400">Diferencia Oficial vs Paralelo</p>
                </div>
            </div>
        </div>
        <footer class="mt-10 text-center text-gray-500 text-sm">
            <p>Datos gestionados vía VCGP</p>
        </footer>
    </div>

    <script>
        // ==========================================
        //  CONFIGURACIÓN: PEGA TU LINK AQUÍ
        // ==========================================
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRyDGG4mzyIikFyThRm0J6ejYZRl5yOdJXY3K5i-lPzMWRv_nmu1mrfNHw_z4q24YXKjGtjQvz7m0op/pub?gid=0&single=true&output=csv'; 
        // Ejemplo: 'https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv'
        // ==========================================

        function init() {
            if(SHEET_URL.includes('PEGAR_AQUI')) {
                alert("¡Ojo! No has pegado el enlace de tu Google Sheet en el código.");
                document.getElementById('loader').style.display = 'none';
                return;
            }

            Papa.parse(SHEET_URL, {
                download: true,
                header: false, // Leemos por posición (Col A, Col B)
                complete: function(results) {
                    procesarDatos(results.data);
                },
                error: function(err) {
                    console.error("Error leyendo Sheet:", err);
                    alert("Error cargando datos. Verifica que el Sheet esté 'Publicado en la Web' como CSV.");
                }
            });
        }

        function procesarDatos(filas) {
            // Convertimos el array de filas en un objeto fácil de usar: { 'kpi_pib': '2.5', ... }
            const datos = {};
            filas.forEach(fila => {
                if(fila[0] && fila[1]) {
                    datos[fila[0].trim()] = fila[1].trim();
                }
            });

            console.log("Datos recibidos:", datos); // Para depuración

            // 1. Asignar Textos Simples
            safeText('last-update', `Actualizado: ${datos['fecha_act'] || 'N/A'}`);
            safeText('kpi-pib', `${datos['kpi_pib']}%`);
            safeText('kpi-pib-var', `${datos['kpi_pib_var']}%`);
            safeText('kpi-inflacion', `${datos['kpi_inflacion']}%`);
            safeText('kpi-rin', datos['kpi_rin']);
            safeText('kpi-desempleo', `${datos['kpi_desempleo']}%`);
            safeText('val-deficit', `${datos['sem_deficit']}%`);
            safeText('val-deuda', `${datos['sem_deuda']}%`);
            safeText('val-cambio', `${datos['sem_brecha']}%`);

            // 2. Ejecutar Semáforos
            updateSemaforo('semaforo-deficit', parseFloat(datos['sem_deficit']), 'deficit');
            updateSemaforo('semaforo-deuda', parseFloat(datos['sem_deuda']), 'deuda');
            updateSemaforo('semaforo-cambio', parseFloat(datos['sem_brecha']), 'brecha');

            // 3. Generar Gráficos (Parseando las comas)
            crearGraficos(datos);

            // Quitar pantalla de carga
            document.getElementById('loader').style.display = 'none';
        }

        // Función auxiliar para no romper si falta un dato
        function safeText(id, text) {
            const el = document.getElementById(id);
            if(el) el.textContent = text.includes('undefined') ? '--' : text;
        }

        function updateSemaforo(baseId, valor, tipo) {
            const bg = document.getElementById(baseId + '-bg');
            const icon = document.getElementById(baseId + '-icon');
            if(isNaN(valor)) return;

            let color = 'bg-gray-200';
            let ico = 'fa-minus';

            if (tipo === 'deficit') {
                if (valor < -5) { color = 'bg-red-500'; ico = 'fa-times'; }
                else if (valor < -3) { color = 'bg-yellow-500'; ico = 'fa-exclamation'; }
                else { color = 'bg-green-500'; ico = 'fa-check'; }
            } else if (tipo === 'deuda') {
                if (valor > 40) { color = 'bg-red-500'; ico = 'fa-arrow-up'; }
                else if (valor > 30) { color = 'bg-yellow-500'; ico = 'fa-minus'; }
                else { color = 'bg-green-500'; ico = 'fa-check'; }
            } else if (tipo === 'brecha') {
                if (valor > 20) { color = 'bg-red-500'; ico = 'fa-exclamation-triangle'; }
                else if (valor > 5) { color = 'bg-yellow-500'; ico = 'fa-exclamation'; }
                else { color = 'bg-green-500'; ico = 'fa-check'; }
            }

            bg.className = `w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-2 shadow-inner ${color}`;
            icon.className = `fas ${ico} text-white text-2xl`;
        }

        function crearGraficos(datos) {
            // 1. Parseo de datos (Igual que antes)
            const pibLabels = (datos['g_pib_labels'] || '').split(',');
            const pibVals = (datos['g_pib_vals'] || '').split(',').map(Number);
            
            const balLabels = (datos['g_bal_labels'] || '').split(',');
            const balExp = (datos['g_bal_exp'] || '').split(',').map(val => Number(val) || 0);
            const balImp = (datos['g_bal_imp'] || '').split(',').map(val => Number(val) || 0);

            // 2. Cálculo del Saldo (Export - Import)
            const balSaldo = balExp.map((exp, index) => exp - balImp[index]);

            // --- Gráfico Línea (PIB) - SIN CAMBIOS ---
            if (document.getElementById('chartPibLine')) {
                // Destruir si existe previo para evitar superposiciones (opcional, buena práctica)
                const chartStatus = Chart.getChart("chartPibLine"); 
                if (chartStatus != undefined) { chartStatus.destroy(); }

                new Chart(document.getElementById('chartPibLine'), {
                    type: 'line',
                    data: {
                        labels: pibLabels,
                        datasets: [{
                            label: 'PIB %',
                            data: pibVals,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });
            }

            // --- Gráfico COMBINADO (Estilo Imagen Oficial) ---
            if (document.getElementById('chartBalanza')) {
                // Limpieza del canvas anterior
                const chartStatus = Chart.getChart("chartBalanza");
                if (chartStatus != undefined) { chartStatus.destroy(); }

                new Chart(document.getElementById('chartBalanza'), {
                    type: 'bar', // El tipo base es Barra (para el Saldo)
                    data: {
                        labels: balLabels,
                        datasets: [
                            // 1. LÍNEA: Exportaciones (Verde Oscuro)
                            {
                                type: 'line',
                                label: 'Exportaciones',
                                data: balExp,
                                borderColor: '#166534', // Verde intenso (green-700)
                                backgroundColor: '#166534',
                                borderWidth: 2,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                tension: 0.3, // Curvatura suave
                                order: 0 // Prioridad 0: Se dibuja AL FRENTE
                            },
                            // 2. LÍNEA: Importaciones (Rojo Oscuro)
                            {
                                type: 'line',
                                label: 'Importaciones',
                                data: balImp,
                                borderColor: '#b91c1c', // Rojo intenso (red-700)
                                backgroundColor: '#b91c1c',
                                borderWidth: 2,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                tension: 0.3,
                                order: 1 // Prioridad 1: Se dibuja detrás de export, pero delante de barras
                            },
                            // 3. BARRAS: Saldo Comercial (Azul Claro)
                            {
                                type: 'bar',
                                label: 'Saldo Comercial',
                                data: balSaldo,
                                backgroundColor: (context) => {
                                    // Azul para positivo, Naranja suave para negativo (opcional)
                                    // O simplemente azul claro como en la imagen:
                                    return '#93c5fd'; // (blue-300)
                                },
                                order: 2 // Prioridad 2: Se dibuja AL FONDO
                            }
                        ]
                    },
                    options: { 
                        responsive: true,
                        interaction: {
                            mode: 'index', 
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { usePointStyle: true }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('es-BO', { style: 'currency', currency: 'USD', maximumSignificantDigits: 3 }).format(context.parsed.y) + ' M';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                               beginAtZero: false, // Permite que las líneas floten si los números son altos
                               grid: {
                                   color: '#e5e7eb',
                                   // Línea cero marcada más fuerte
                                   lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1,
                                   color: (ctx) => ctx.tick.value === 0 ? '#9ca3af' : '#e5e7eb',
                               }
                           },
                           x: {
                               ticks: {
                                   maxRotation: 90, // Rota etiquetas si son muchas (como en tu imagen)
                                   minRotation: 0
                               }
                           }
                       }
                    }
                });
            }
        }

        // Arrancar
        init();
    </script>
</body>
</html>
